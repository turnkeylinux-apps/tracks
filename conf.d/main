#!/bin/bash -ex
SRC=/usr/local/src
WEBROOT=/var/www/tracks

ADMIN_NAME=admin
ADMIN_PASS=turnkey1

# start mysql
service mysql start

[[ -z "$FAB_HTTP_PROXY" ]] || export http_proxy=$FAB_HTTP_PROXY
[[ -z "$FAB_HTTPS_PROXY" ]] || export https_proxy=$FAB_HTTPS_PROXY

# clone repo
REPO=TracksApp/tracks
VERSION=$(gh_releases $REPO | grep -iv 'ALPHA\|BETA\|RC' | sort -V | tail -1)
mv $WEBROOT $WEBROOT.orig
git clone --branch=$VERSION https://github.com/$REPO $WEBROOT

# config
cp $WEBROOT.orig/config/database.yml $WEBROOT/config/database.yml
cp $WEBROOT/config/site.yml.tmpl $WEBROOT/config/site.yml
rm $WEBROOT/.ruby-version # required to install on latest Ruby stable (v3.1)

# install
cd $WEBROOT
export RAILS_ENV="production"
bundle config set --local path 'vendor/bundle'
bundle config set --local without 'postgresql sqlite'
bundle install
bundle exec rake db:migrate

# configure permissions
mkdir -p $WEBROOT/{tmp/cache,public/uploads/csv}
chown -R www-data:www-data $WEBROOT/{tmp,log,public/uploads}
chmod 666 $WEBROOT/log/*

# precompile assets
# Setting 'RAILS_GROUPS=assets' works around
# https://github.com/TracksApp/tracks/issues/3065
# See https://github.com/TracksApp/tracks/issues/3065#issuecomment-2400803381
# for reason/rationale.
RAILS_GROUPS=assets bundle exec rake assets:precompile

# turnkey-credit (passenger substitute x2 bug)
cat >>$WEBROOT/app/assets/stylesheets/tracks.css.scss<<EOF
#turnkey-credit {
    font-family: Tahoma,Sans,Arial,Helvetica,Verdana,sans-serif;
    font-size: 11px;
    text-align: center;
    padding-top: 5px;
}
#turnkey-credit a {
    text-decoration: none;
}
EOF

TURNKEY_CREDIT="<div id='turnkey-credit'> <div> <a href='https://www.turnkeylinux.org/tracks'>Tracks Appliance</a> - Powered by <a href='https://www.turnkeylinux.org'>TurnKey Linux</a> </div> </div>"

FOOTER=$WEBROOT/app/views/shared/_footer.html.erb
sed -i "s|</div>|$TURNKEY_CREDIT\n</div>|" $FOOTER

service apache2 start

sleep 5

# create admin user & init app settings
TOKEN=$( curl -c /tmp/cookies.txt -s http://localhost/signup \
        | grep -o '<input type="hidden" name="authenticity_token" .* />' \
        | grep -o 'value=".*"' \
        | grep -o '".*"' \
        | tr -d \" )

curl -s -X POST -b /tmp/cookies.txt http://localhost/users \
        --data-urlencode "utf8=âœ“" \
        --data-urlencode "authenticity_token=${TOKEN}" \
        --data-urlencode "user%5Blogin%5D=${ADMIN_NAME}" \
        --data-urlencode "user%5Bpassword%5D=${ADMIN_PASS}" \
        --data-urlencode "user%5Bpassword_confirmation%5D=${ADMIN_PASS}"

# clean up & finalize
rm -rf $WEBROOT.orig
unset RAILS_ENV http_proxy https_proxy
rm -f /tmp/cookies.txt
rails tmp:clear
service mysql stop
service apache2 stop
